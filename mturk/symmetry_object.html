<html>
  <head>
    <title>Indicate if there is a change in the image</title>
    <!-- simpleamt depends on these libraries -->
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>    
    <!-- end of required libraries -->
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js'></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
      #text-area {
        margin: 10px 0;
        font-size: 24pt;
      }
      #button-div {
        margin-bottom: 10px;
      }
      #counter {
        margin: 0 10px;
        font-size: 20pt;
        font-weight: bold;
      }
      img {
        height: 500px;
      }
      .bordered {
        border-style: solid;
        border-width: 1px;
        border-color: gray;
      }
    </style>
  </head>
  <body>
    <section class="container" id="Categorization"><!-- Instructions (collapsible) -->
      <div class="row">
        <div class="col-xs-12 col-md-12">
          <div class="panel panel-primary"><!-- WARNING: the ids "collapseTrigger" and "instructionBody" are being used to enable expand/collapse feature -->
            <div class="panel-heading" role="tab" id="collapseTrigger">
             <h4 class="panel-title">
                <strong>Hover over to image to see if the image changes.</strong>
             </h4>
            </div>
            <div class="panel-body" id="instructionHeader">
              <p>We are trying to understand how people perceive object symmetries.  
              You will be given <span id="numEntries"></span> pairs of images.  Place you mouse on top and out of the image box to see the different image.  
              Please indicate if you think the two images are identical ("None"), or if you can detect the two images as being diffrent ("Clearly different").  Select "Tiny" if there is tiny difference that is hard to see but you detect a change, "Slight" if you see a difference but you don't think it is semantically important. Select "N/A" if for something you can't see any images.
              </p>
              <p>Click <span style="color: #2e6da4;">"Next"</span> to go to the next item and <span style="color: #4cae4c;">"Submit"</span> when you are done.</p>
<!--               <p>See the
                <a class="collapsed" data-parent="#Categorization" data-toggle="collapse" href="#instructionBody" aria-expanded="false" aria-controls="instructionBody">
                  <strong>Selection Criteria</strong>
                  <span class="collapse-text">(Click to expand)</span>
                </a> below for more details.
              </p>
 -->
            </div>

            <div class="panel-body panel-collapse collapse" id="instructionBody" aria-labelledby="collapseTrigger" style="display: none;">
              <!-- Detailed instructions for the Worker-->

              <table class="table table-condensed table-striped table-responsive">
                <tbody>
                </tbody>
                <colgroup>
                  <col class="col-xs-2 col-md-2" />
                  <col class="col-xs-5 col-md-5" />
                  <col class="col-xs-5 col-md-5" />
                </colgroup>
                <!-- By explaining what is or is not included in a category, the accuracy of the answers may increase. -->
                <tbody id="categoriesTable">
                  <tr>
                    <th>Category</th>
                    <th>Expresses</th>
                  </tr>
                  <!-- Add instructions for each category below. Don't forget to rename the categories. -->
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </section>

    <div class='container-fluid'>
      <div class='row'>
        <div class='col-xs-12 text-center'>
          <div id='choices' class='btn-group'>
          </div>
        </div>
      </div>
      <div class='row'>
        <div class='col-xs-12 text-center'>
          <div id='image-container'>
          </div>
        </div>
      </div>
      <div class='row'>
        <div class='col-xs-4 col-xs-offset-4 text-center' id='button-div'>
          <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
          <span id='counter'>
            <span class='counter-top'></span> / <span class='counter-bottom'></span>
          </span>
          <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
        </div>
      </div>
    </div>

    {% include "hit_templates/simpleamt.html" %}

    <script>
      $(function() {
        function toItem(id) {
          return {
            id: id,
            image1: baseImageUrl + id + ".0.tmp.png",
            image2: baseImageUrl + id + ".1.tmp.png",
          };
        }

        var categories = [
          { "label": "None", "value": "0", "description": "I can't detect any changes", "shortcut": '1'},
          { "label": "Tiny", "value": "1", "description": "I think I detect some flickering when hovering over the image, but I can't really pinpoint what is different", "shortcut": '2'},
          { "label": "Slight", "value": "2", "description": "There are slight differences, but I don't find the differences to be meaningful", "shortcut": '3'},
          { "label": "Clearly different", "value": "3", "description": "The two images are clearly different", "shortcut": '4'},
          { "label": "N/A", "value": "-1", "description": "Something is wrong and I can't see any images", "shortcut": 'X'},
        ];
        var valid_values = categories.map(function(x) { return x.value; });

        // Define some default input.
        var baseImageUrl = "http://shapenet.cs.stanford.edu/shapenet/screenshots/models/symmetry_detection/";
        var ids = [
          "02691156/79351c8f83f5a3abb2d09bc8d348e46b_s1_v0",
          "02691156/783f3f72d5639597ba0d990ae229b477_s1_v1",
          "02691156/f6b96f56212f55363023a5c0cae3fffe_s1_v1",
          "02691156/6826af6513566b12f4aab844bf68e35e_s1_v1",
          "02691156/61bd590e917928f6b6ecbbb2e4d05900_s3_v0"
        ]; 
        var DEFAULT_INPUT = ids.map(function(id) {
          return toItem(id);
        });

        var input = null;
        var useKeyshortcuts = true;
        var keyCodeMap = {};

        // Annotations (parallel to input)
        var annotationElems = [];
        var annotations = [];

        // Some variables to track state of the HIT.
        var idx = 0;
        var enabled = false;

        function swap_image_source() {
            var newSource = $(this).data('alt-src');
            $(this).data('alt-src', $(this).attr('src'));
            $(this).attr('src', newSource);
        }

        function createUI() {
          // Populate instructions
          var numEntriesElem = $('#numEntries');
          numEntriesElem.text(input.length);
          // Populate choices
          var choices = $('#choices');
          for (var i = 0; i < categories.length; i++) {
            var category = categories[i];
            var inputElem = $("<input/>").attr("type", "radio").attr("name", category.label)
                      .attr("value", category.value).prop("hidden", true).prop("disabled", true);
            var shortcut = (category.shortcut != null)? ' (' + category.shortcut + ')': '';
            var labelElem = $("<label></label>").attr("class", "btn btn-default")
                  .text(category.label + shortcut) 
                  .attr("title", category.description).append(inputElem);
            var categoryButton = $("<div></div>").attr("class", "radio-inline").append(labelElem).prop("disabled", true);
            choices.append(categoryButton);
            annotationElems.push({ radio: inputElem, button: categoryButton });
            if (category.shortcut != null) {
              keyCodeMap[category.shortcut.toUpperCase().charCodeAt(0)] = i;
            }
          }
        }

        function preloadImages(images) {
          // Preload all images
          var imgs = [];
          _.each(images, function(img_url) {
            var img = new Image();
            img.onload = function() { console.log('loaded image from ' + img_url); };
            img.src = img_url;
          });
        }

        function main() {
          // If this is a HIT on AMT, then replace the default input with the real input.
          input = simpleamt.getInput(DEFAULT_INPUT);
          input = input.map(function(item) {
            if (typeof item === 'string') {
              return toItem(item);
            } else {
              return item;
            }
          });

          createUI();

          // Enable the UI if the HIT is not in preview mode.
          if (!simpleamt.isPreview()) {
            enable_hit();
          }

          // Set up the annotations.
          _.each(input, function() { annotations.push(null); });

          preloadImages(input.map(function(x) { return x.image1; }));
          preloadImages(input.map(function(x) { return x.image2; }));

          render();
        }

        function showAnnotation(value) {
          $('#choices').find('label').removeClass('active');
          $('#choices').find('label input').prop('checked', false);
          if (value) {
            var inputElem = $('#choices').find('label input[value=' + value + ']');
            inputElem.prop('checked', true);
            inputElem.parent().addClass('active');
          }
        }

        // Use the current index to update the image and description
        function render() {
          // Set up the image
          $('#image-container').empty();
          $('<img>').attr('src', input[idx].image1)
            .data('alt-src', input[idx].image2)
            .addClass('withHover')
            .addClass('bordered')
            .appendTo($('#image-container'));
          $('img.withHover').hover(swap_image_source, swap_image_source);

          showAnnotation(annotations[idx]);

          // Refresh the counter
          $('.counter-top').text(idx + 1);
          $('.counter-bottom').text(input.length);

          // If the UI is enabled, enable or disable the buttons depending on
          // the index.
          if (enabled) {
            var prev_btn = $('#prev-btn');
            var next_btn = $('#next-btn');
            prev_btn.prop('disabled', true);
            next_btn.prop('disabled', true);
            if (idx > 0) {
              prev_btn.prop('disabled', false);
            }
            if (idx < input.length - 1) next_btn.prop('disabled', false);
          }
        }

        // Save current annotation
        function save_current() {
          annotations[idx] = $('#choices input:radio:checked').val();
          // console.log('save', annotations[idx], idx);
        }

        // Update the index, and save the text in the text area.
        function set_idx(new_idx) {
          if (new_idx < 0 || new_idx >= input.length) return;
          save_current();

          idx = new_idx;
          render();
        }

        function hookupKeys() {
          if (useKeyshortcuts) {
            window.addEventListener("keyup", function (event) {
              var tagName = (event.target || event.srcElement).tagName;
              var isInputText = (tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA');
              if (!isInputText) {
                if (event.keyCode === 37 /* left arrow */) {
                  $('#prev-btn').click();
                } else if (event.keyCode == 39 /* right arrow */) {
                  $('#next-btn').click();
                }
                var index = keyCodeMap[event.keyCode];
                if (index != null) {
                  annotationElems[index].radio.click();
                  annotationElems[index].button.click();
                  return false;
                }
              }
            });
          }
        }

        // Enable the UI.
        function enable_hit() {
          enabled = true;

          // Enable components
          $('#next-btn').click(function() { set_idx(idx + 1); });
          $('#prev-btn').click(function() { set_idx(idx - 1); });
          $('#submit-btn').prop('disabled', false);
          for (var i = 0; i < annotationElems.length; i++) {
            var inputElem = annotationElems[i];
            inputElem.radio.prop('disabled', false);
            inputElem.button.prop('disabled', false);
            inputElem.button.click(function(event) {
              $('#choices').find('label').removeClass('active');
              $(this).find('label').addClass('active');
            });
          }
          hookupKeys();

          // Set up submit handler.
          simpleamt.setupSubmit();
          $('#submit-btn').click(function() {
            save_current();
            var invalidIndex = _.findIndex(annotations, function(d) { return d == null || valid_values.indexOf(d) < 0; });
            if (invalidIndex >= 0) {
              alert('Not all images annotated. Correct entry #' + (invalidIndex+1) + ' before submitting.');
              return false;
            }
            var output = _.map(_.zip(input, annotations), function(x) {
              return {'id': x[0].id, 'annotation': x[1]};
            });
            simpleamt.setOutput(output);
          });
        }

        main();
      });
    </script>
  </body>
</html>
